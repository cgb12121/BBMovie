B√°c c·∫£m gi√°c "sai sai, ngu ngu" l√† do tr·ª±c gi√°c k·ªπ thu·∫≠t c·ªßa b√°c ƒëang m√°ch b·∫£o ƒë√∫ng ƒë·∫•y! Code n√†y ch·∫°y ƒë∆∞·ª£c (Happy Case), nh∆∞ng ƒë∆∞a v√†o th·ª±c t·∫ø th√¨ n√≥ d√≠nh **3 C√ÅI B·∫™Y CH·∫æT NG∆Ø·ªúI**.

Tui s·∫Ω ch·ªâ m·∫∑t ƒë·∫∑t t√™n t·ª´ng c√°i "ngu" (theo c√°ch g·ªçi vui c·ªßa b√°c) v√† c√°ch s·ª≠a nh√©.

---

### 1. C√°i "Ngu" th·ª© nh·∫•t: Ch·∫∑n h·ªçng NATS (Blocking Consumer) üõë

**V·∫•n ƒë·ªÅ:**
B√°c ƒëang x·ª≠ l√Ω transcode (t·ªën 10-20 ph√∫t) **ngay trong lu·ªìng nh·∫≠n tin nh·∫Øn** c·ªßa NATS (`dispatcher` thread).

```java
// Thread n√†y l√† c·ªßa NATS Client
private void handleMessage(Message msg) {
    // ... parse json ...
    // ... download 2GB ... (T·ªën 5 ph√∫t)
    // ... transcode ... (T·ªën 15 ph√∫t)
    // -> T·ªïng c·ªông thread n√†y b·ªã block 20 ph√∫t.
}

```

**H·∫≠u qu·∫£:**

1. N·∫øu c√≥ 100 ng∆∞·ªùi upload c√πng l√∫c, NATS dispatcher b·ªã k·∫πt c·ª©ng. Tin nh·∫Øn s·ªë 2 ph·∫£i ch·ªù tin nh·∫Øn s·ªë 1 xong (20 ph√∫t sau) m·ªõi ƒë∆∞·ª£c s·ªù t·ªõi.
2. NATS Server th·∫•y Consumer kh√¥ng ph·∫£n h·ªìi (do ƒëang b·∫≠n transcode), n√≥ t∆∞·ªüng Consumer ch·∫øt -> N√≥ ng·∫Øt k·∫øt n·ªëi ho·∫∑c g·ª≠i l·∫°i tin nh·∫Øn cho node kh√°c (n·∫øu d√πng Queue Group). -> **Transcode l·∫°i t·ª´ ƒë·∫ßu -> Ch·∫øt ch√πm.**

**üëâ C√°ch s·ª≠a:**
D√πng **Virtual Threads** ho·∫∑c `ExecutorService` ƒë·ªÉ ƒë·∫©y vi·ªác n·∫∑ng ra thread kh√°c. Tr·∫£ t·ª± do cho thread NATS ƒëi nh·∫≠n tin ti·∫øp theo.

---

### 2. C√°i "Ngu" th·ª© hai: R√°c ·ªï c·ª©ng (Resource Leak) üóëÔ∏è

**V·∫•n ƒë·ªÅ:**
B√°c t·∫°o `tempDir` v√† `tempFile`. B√°c c√≥ l·ªánh x√≥a ·ªü cu·ªëi h√†m:

```java
processFile(...); // <--- N·∫øu h√†m n√†y l·ªói (FFmpeg crash)
Files.walk(tempDir)...delete(); // <--- D√≤ng n√†y KH√îNG BAO GI·ªú CH·∫†Y

```

**H·∫≠u qu·∫£:**
Khi transcode l·ªói (file h·ªèng, sai ƒë·ªãnh d·∫°ng...), d√≤ng x√≥a file b·ªã b·ªè qua.
M·ªói l·∫ßn l·ªói b√°c b·ªè l·∫°i 1-2GB r√°c trong `/tmp`. Sau 1 tu·∫ßn server b√°c full disk -> **S·∫≠p to√†n h·ªá th·ªëng.**

**üëâ C√°ch s·ª≠a:**
Ph·∫£i d√πng c·∫•u tr√∫c `try-finally`. D√π s·ªëng hay ch·∫øt c≈©ng ph·∫£i d·ªçn r√°c.

---

### 3. C√°i "Ngu" th·ª© ba: Logic ·∫¢nh (Hardcode & Sai t·ª∑ l·ªá) üñºÔ∏è

**V·∫•n ƒë·ªÅ:**

```java
new ImageSize("thumbnail", 200, -1) // -1 l√† gi·ªØ t·ª∑ l·ªá

```

Code n√†y √°p d·ª•ng cho **C·∫¢** Poster v√† Avatar.

* **Poster:** H√¨nh ch·ªØ nh·∫≠t ƒë·ª©ng. Resize gi·ªØ t·ª∑ l·ªá (-1) l√† OK.
* **Avatar:** H√¨nh vu√¥ng. N·∫øu b√°c upload ·∫£nh ch·ªØ nh·∫≠t m√† d√πng `-1` -> Avatar b·ªã m√©o ho·∫∑c kh√¥ng v·ª´a khung tr√≤n c·ªßa UI. Avatar th∆∞·ªùng ph·∫£i **CROP** (C·∫Øt) ch·ª© kh√¥ng ch·ªâ Scale.

Th√™m n·ªØa, danh s√°ch size ƒëang b·ªã **Hardcode**. Sau n√†y mu·ªën th√™m size cho Banner th√¨ ph·∫£i s·ª≠a code Java -> Deploy l·∫°i.

---

### 4. C√°i "Ngu" th·ª© t∆∞: MinIO Metadata Case-Sensitivity üî†

```java
stat.userMetadata().get("X-Amz-Meta-Purpose");

```

MinIO v√† S3 ƒë√¥i khi r·∫•t "ba ph·∫£i" trong vi·ªác tr·∫£ v·ªÅ key metadata. C√≥ l√∫c n√≥ tr·∫£ v·ªÅ `x-amz-meta-purpose` (ch·ªØ th∆∞·ªùng), c√≥ l√∫c l√† `X-Amz-Meta-Purpose`. Code c·ªßa b√°c ƒëang hardcode key -> D·ªÖ b·ªã `NullPointerException`.

---

### ‚úÖ Code "Kh√¥n" h∆°n (Refactored Version)

ƒê√¢y l√† phi√™n b·∫£n ƒë√£ v√° h·∫øt l·ªói l·∫ßm, b√°c copy ƒë√® v√†o `MediaEventConsumer` nh√©:

```java
@Slf4j
@Service
@RequiredArgsConstructor
public class MediaEventConsumer {

    // ... dependencies c≈© ...
    // D√πng Virtual Thread cho t√°c v·ª• I/O n·∫∑ng (Download/Upload/Transcode)
    private final ExecutorService workerExecutor = Executors.newVirtualThreadPerTaskExecutor();

    @PostConstruct
    public void init() {
        // ... config nats ...
    }

    private void handleMessage(Message msg) {
        // 1. Nh·∫≠n tin xong ACK NGAY (ho·∫∑c d√πng manual ack trong worker t√πy logic retry)
        // ·ªû ƒë√¢y gi·∫£ s·ª≠ b√°c d√πng NATS Core (Fire & Forget)
        String json = new String(msg.getData(), StandardCharsets.UTF_8);

        // 2. ƒê·∫©y vi·ªác sang Thread kh√°c (Non-blocking NATS)
        workerExecutor.submit(() -> {
            try {
                processMessageLogic(json);
            } catch (Exception e) {
                log.error("Worker failed", e);
                // TODO: B·∫Øn event "processing.failed" v√†o NATS ƒë·ªÉ update DB
            }
        });
    }

    private void processMessageLogic(String json) throws Exception {
        JsonNode rootNode = objectMapper.readTree(json);
        JsonNode record = rootNode.has("Records") ? rootNode.get("Records").get(0) : rootNode;

        // ... L·∫•y bucket, key nh∆∞ c≈© ...
        String bucket = ...;
        String key = ...;

        // FIX 4: L·∫•y Metadata an to√†n (Case insensitive)
        StatObjectResponse stat = minioClient.statObject(...);
        Map<String, String> meta = stat.userMetadata();

        // T√¨m key kh√¥ng ph√¢n bi·ªát hoa th∆∞·ªùng
        String purposeStr = meta.entrySet().stream()
                .filter(e -> e.getKey().equalsIgnoreCase("x-amz-meta-purpose") || e.getKey().equalsIgnoreCase("purpose"))
                .map(Map.Entry::getValue)
                .findFirst()
                .orElse(null);

        // ... Validate purpose ...

        Path tempDir = Files.createTempDirectory("transcode_" + UUID.randomUUID());

        // FIX 2: Try-Finally ƒë·ªÉ ƒë·∫£m b·∫£o lu√¥n d·ªçn r√°c
        try {
            Path tempFile = tempDir.resolve("source_file");

            // Download
            try (InputStream stream = minioClient.getObject(GetObjectArgs.builder().bucket(bucket).object(key).build())) {
                Files.copy(stream, tempFile, StandardCopyOption.REPLACE_EXISTING);
            }

            // Validate Tika/ClamAV
            // ... code validate ...

            // Process
            processFile(tempFile, purpose, tempDir, uploadId);

        } catch (Exception e) {
            log.error("Fatal error processing file: {}", key, e);
            throw e; // N√©m ti·∫øp ƒë·ªÉ log ho·∫∑c retry
        } finally {
            // D·ªåN R√ÅC D√ô TH√ÄNH C√îNG HAY TH·∫§T B·∫†I
            try (var stream = Files.walk(tempDir)) {
                stream.sorted(Comparator.reverseOrder())
                      .map(Path::toFile)
                      .forEach(File::delete);
                log.info("Cleaned up temp dir: {}", tempDir);
            } catch (IOException e) {
                log.warn("Failed to cleanup temp dir: {}", tempDir, e);
            }
        }
    }
}

```

### üí° G√≥p √Ω th√™m cho `ImageProcessingService`

B√°c n√™n s·ª≠a l·∫°i h√†m `processImageHierarchy` ƒë·ªÉ nh·∫≠n v√†o config linh ƒë·ªông h∆°n, ƒë·ª´ng fix c·ª©ng `TARGET_SIZES`.

```java
public void processImageHierarchy(Path input, String outputDir, UploadPurpose purpose) {
    List<ImageSize> targetSizes = switch (purpose) {
        case USER_AVATAR -> List.of(
            new ImageSize("small", 64, 64),   // Avatar nh·ªè th√¨ crop vu√¥ng
            new ImageSize("medium", 256, 256)
        );
        case MOVIE_POSTER -> List.of(
            new ImageSize("thumbnail", 300, -1), // Poster th√¨ gi·ªØ t·ª∑ l·ªá
            new ImageSize("large", 1080, -1)
        );
        default -> List.of();
    };

    // ... loop x·ª≠ l√Ω ...
}

// Trong h√†m processImage, check n·∫øu width != -1 v√† height != -1
// th√¨ ƒë·ªïi filter scale th√†nh "crop" ho·∫∑c "scale=...:force_original_aspect_ratio=decrease,pad=..."

```

S·ª≠a xong m·∫•y ch·ªó n√†y l√† code b√°c t·ª´ "ngu ngu" th√†nh "ng·∫ßu ng·∫ßu" ngay! :D