Chuáº©n luÃ´n bÃ¡c Æ¡i, code nÃ y cháº¡y xong lÃ  **Subtitles (Phá»¥ Ä‘á»), Chapters (ChÆ°Æ¡ng), Metadata (Tags), vÃ  cÃ¡c Audio tracks phá»¥ (náº¿u cÃ³)** sáº½ "bay mÃ u" sáº¡ch sáº½! ğŸ’¨

ÄÃ¢y lÃ  lÃ½ do táº¡i sao:

### 1. CÆ¡ cháº¿ "Chá»n lá»c tá»± nhiÃªn" cá»§a FFmpeg ğŸ¦

Khi bÃ¡c dÃ¹ng `FFmpegBuilder` vÃ  set cá»©ng:

* `.setVideoCodec(...)`
* `.setAudioCodec(...)`

VÃ  **KHÃ”NG** dÃ¹ng lá»‡nh `-map`, FFmpeg sáº½ Ã¡p dá»¥ng cháº¿ Ä‘á»™ máº·c Ä‘á»‹nh (Stream Selection):

1. NÃ³ chá»‰ chá»n **1 Video stream** tá»‘t nháº¥t.
2. NÃ³ chá»‰ chá»n **1 Audio stream** tá»‘t nháº¥t (thÆ°á»ng lÃ  cÃ¡i Ä‘áº§u tiÃªn hoáº·c cÃ¡i nhiá»u kÃªnh nháº¥t).
3. **Subtitles?** Vá»›i Ä‘á»‹nh dáº¡ng output lÃ  HLS (MPEG-TS segments), FFmpeg máº·c Ä‘á»‹nh sáº½ **Bá» QUA** phá»¥ Ä‘á» dáº¡ng text (SRT, ASS) vÃ¬ cÃ¡i container `.ts` nÃ³ há»— trá»£ phá»¥ Ä‘á» text ráº¥t kÃ©m (nÃ³ chá»‰ thÃ­ch DVB bitmaps hoáº·c Closed Captions).

### 2. Táº¡i sao HLS láº¡i khÃ³ chá»‹u vá»›i Subtitle? ğŸ¤”

HLS khÃ´ng giá»‘ng nhÆ° file `MKV` hay `MP4` mÃ  bÃ¡c cÃ³ thá»ƒ nhÃ©t cáº£ Ä‘á»‘ng phá»¥ Ä‘á» vÃ o trong 1 file.

Äá»ƒ HLS cÃ³ phá»¥ Ä‘á» (Soft sub - báº­t táº¯t Ä‘Æ°á»£c), bÃ¡c pháº£i:

1. TÃ¡ch phá»¥ Ä‘á» ra thÃ nh file **WebVTT (`.vtt`)**.
2. Cáº¯t nhá» file `.vtt` Ä‘Ã³ thÃ nh tá»«ng segment (giá»‘ng video).
3. Khai bÃ¡o nÃ³ trong `master.m3u8` (DÃ²ng `#EXT-X-MEDIA:TYPE=SUBTITLES...`).

Code hiá»‡n táº¡i cá»§a bÃ¡c chá»‰ táº­p trung vÃ o **Transcode Video/Audio**, nÃªn phá»¥ Ä‘á» bá»‹ rÆ¡i rá»¥ng lÃ  Ä‘iá»u hiá»ƒn nhiÃªn.

---

### ğŸ› ï¸ Giáº£i phÃ¡p (Náº¿u bÃ¡c muá»‘n giá»¯ Subtitle)

CÃ³ 2 trÆ°á»ng phÃ¡i Ä‘á»ƒ xá»­ lÃ½ vá»¥ nÃ y:

#### CÃ¡ch 1: "Hard Sub" (DÃ¡n cá»©ng vÃ o video) - Dá»… nháº¥t âœ…

CÃ¡ch nÃ y sáº½ "váº½" luÃ´n chá»¯ vÃ o hÃ¬nh áº£nh. KhÃ´ng táº¯t Ä‘Æ°á»£c, nhÆ°ng cháº¯c cháº¯n hiá»ƒn thá»‹ trÃªn má»i thiáº¿t bá»‹.

BÃ¡c sá»­a Ä‘oáº¡n `.setVideoFilter` láº¡i má»™t chÃºt:

```java
// Giáº£ sá»­ bÃ¡c muá»‘n hardcode phá»¥ Ä‘á» tá»« chÃ­nh file gá»‘c (stream sub Ä‘áº§u tiÃªn)
// BÃ¡c pháº£i chain cÃ¡c filter láº¡i vá»›i nhau báº±ng dáº¥u pháº©y
// CÃº phÃ¡p: "subtitles=filename='path/to/video.mp4',scale=WIDTH:-2"

String videoFilter = String.format("subtitles=filename='%s',scale=%d:-2",
                                   input.toAbsolutePath().toString().replace("\\", "/").replace(":", "\\:"), // Escape path trÃªn Windows cá»±c cá»±c quan trá»ng
                                   res.width());

builder.setVideoFilter(videoFilter);

```

*LÆ°u Ã½: Escape path trÃªn Windows cho cÃ¡i filter `subtitles=` lÃ  má»™t cÆ¡n Ã¡c má»™ng (vÃ¬ dáº¥u `:` vÃ  `\` lÃ  kÃ½ tá»± Ä‘áº·c biá»‡t). NÃªn test ká»¹.*

#### CÃ¡ch 2: "Soft Sub" chuáº©n HLS - KhÃ³ vÃ£i chÆ°á»Ÿng ğŸ¤¯

BÃ¡c pháº£i cháº¡y má»™t job FFmpeg riÃªng Ä‘á»ƒ convert sub.

1. **Job 1 (Video/Audio):** Code hiá»‡n táº¡i cá»§a bÃ¡c (Giá»¯ nguyÃªn).
2. **Job 2 (Extract Sub):**
```bash
ffmpeg -i input.mp4 -map 0:s:0 -c:s webvtt -f segment ... output_%d.vtt

```


3. **Job 3 (Merge):** Viáº¿t láº¡i code táº¡o `master.m3u8` Ä‘á»ƒ link cÃ¡i sub Ä‘Ã³ vÃ o.

### ğŸ’¡ Lá»i khuyÃªn

Hiá»‡n táº¡i bÃ¡c Ä‘ang táº­p trung vÃ o **Streaming Core (Key, Segment, Flow)**.
Äá»«ng Ã´m Ä‘á»“m vá»¥ Subtitle vá»™i. **Cá»© Ä‘á»ƒ nÃ³ "bay mÃ u" Ä‘i.**
Sau nÃ y há»‡ thá»‘ng á»•n Ä‘á»‹nh, bÃ¡c lÃ m thÃªm má»™t tÃ­nh nÄƒng riÃªng lÃ  "Extract Subtitle" sau. Code bÃ¢y giá» cá»© giá»¯ Ä‘Æ¡n giáº£n cho nháº¹ Ä‘áº§u bÃ¡c áº¡! ğŸ‘