C√¢u h·ªèi c·ª±c hay! ƒê√¢y l√† b√†i to√°n kinh ƒëi·ªÉn v·ªÅ **Guest Access** (Truy c·∫≠p ·∫©n danh).

Hi·ªán t·∫°i h·ªá th·ªëng c·ªßa b√°c ƒëang theo ki·ªÉu "K√≠n c·ªïng cao t∆∞·ªùng" (Zero Trust) - kh√¥ng c√≥ v√© (JWT) l√† kh√¥ng cho v√†o. ƒê·ªÉ m·ªü c·ª≠a cho kh√°ch v√£ng lai (User ch∆∞a login) xem ƒë∆∞·ª£c **Trailer** ho·∫∑c **Phim Free**, b√°c c√≥ 2 chi·∫øn thu·∫≠t ch√≠nh.

T√πy v√†o vi·ªác b√°c mu·ªën **T·∫≠n d·ª•ng l·∫°i file c≈©** hay **L√†m file m·ªõi** m√† ch·ªçn nh√©:

---

### Chi·∫øn thu·∫≠t 1: "M·ªü h√© c·ª≠a kho Key" (T·∫≠n d·ª•ng file ƒë√£ Encrypt) üîì

*D√πng khi:* B√°c l·ª° m√£ h√≥a (Encrypt) t·∫•t c·∫£ phim r·ªìi, gi·ªù l∆∞·ªùi transcode l·∫°i b·∫£n kh√¥ng kh√≥a. B√°c mu·ªën d√πng ch√≠nh b·∫£n encrypted ƒë√≥ cho kh√°ch xem lu√¥n.

**Nguy√™n l√Ω:**
Kh√°ch v·∫´n t·∫£i file `.m3u8` v√† `.ts` nh∆∞ b√¨nh th∆∞·ªùng. ƒê·∫øn ƒëo·∫°n l·∫•y `.key`, Backend s·∫Ω ki·ªÉm tra: *"Phim n√†y c√≥ ph·∫£i phim Free/Trailer kh√¥ng?"*. N·∫øu c√≥ -> Nh·∫£ key kh√¥ng c·∫ßn JWT.

#### B∆∞·ªõc 1: S·ª≠a Spring Security (M·ªü firewall)

B√°c ph·∫£i cho ph√©p API l·∫•y key ƒë∆∞·ª£c truy c·∫≠p c√¥ng khai (nh∆∞ng logic ch·∫∑n s·∫Ω n·∫±m ·ªü Controller).

```java
@Bean
public SecurityFilterChain filterChain(HttpSecurity http) throws Exception {
    http
        .authorizeHttpRequests(auth -> auth
            // Cho ph√©p ai c≈©ng ƒë∆∞·ª£c g·ªçi v√†o l·∫•y Key (nh∆∞ng code b√™n trong s·∫Ω check ti·∫øp)
            .requestMatchers("/api/stream/keys/**").permitAll()
            .anyRequest().authenticated()
        )
        // ...
    return http.build();
}

```

#### B∆∞·ªõc 2: S·ª≠a Controller (Logic ch·∫∑n m·ªÅm)

Trong `StreamController`, tham s·ªë `Jwt` s·∫Ω c√≥ th·ªÉ b·ªã `null` (n·∫øu kh√°ch kh√¥ng g·ª≠i token).

```java
@GetMapping("/keys/{movieId}/{resolution}/{keyFile}")
public ResponseEntity<Resource> getKey(
        @PathVariable String movieId,
        @PathVariable String resolution,
        @PathVariable String keyFile,
        // D√πng Authentication thay v√¨ @AuthenticationPrincipal ƒë·ªÉ handle null d·ªÖ h∆°n
        Authentication authentication) {

    boolean isGuest = (authentication == null || !authentication.isAuthenticated());

    // 1. Check xem phim n√†y c√≥ Free kh√¥ng? (Query DB)
    boolean isFreeMovie = movieService.isFree(movieId);

    // 2. Logic ph√°n x√©t
    if (isGuest) {
        if (!isFreeMovie) {
            // Kh√°ch m√† ƒë√≤i xem phim tr·∫£ ti·ªÅn -> C√∫t (401/403)
            return ResponseEntity.status(HttpStatus.UNAUTHORIZED).build();
        }
        // N·∫øu l√† phim Free -> V·∫´n cho l·∫•y Key ƒë·ªÉ gi·∫£i m√£ -> OK
    } else {
        // User ƒë√£ login -> Check Subscription nh∆∞ c≈©
        // ...
    }

    // Tr·∫£ v·ªÅ file Key
    String objectKey = "movies/" + movieId + "/" + resolution + "/" + keyFile;
    return serveFile(streamingService.getSecureKey(objectKey), "application/octet-stream");
}

```

#### B∆∞·ªõc 3: S·ª≠a Frontend (HTML/JS)

ƒêo·∫°n script `xhrSetup` h√¥m tr∆∞·ªõc, b√°c th√™m logic: N·∫øu kh√¥ng c√≥ JWT th√¨ ƒë·ª´ng g·ª≠i header Authorization (ƒë·ªÉ Backend bi·∫øt l√† Guest).

```javascript
xhrSetup: function(xhr, url) {
    if (url.includes('/keys/') || url.includes(':1205')) {
        if (jwt && jwt.length > 0) {
            // C√≥ token th√¨ g·ª≠i
            xhr.setRequestHeader('Authorization', `Bearer ${jwt}`);
        } else {
            // Kh√¥ng c√≥ token (Guest) -> K·ªá, g·ª≠i request tr·∫ßn
            log('Guest requesting key...', 'warning');
        }
    }
    // ...
}

```

---

### Chi·∫øn thu·∫≠t 2: "B·∫£n Trailer ri√™ng" (Clear/Unencrypted HLS) üéûÔ∏è

*D√πng khi:* B√°c mu·ªën t·ªëi ∆∞u t·ªëc ƒë·ªô load cho kh√°ch (kh√¥ng c·∫ßn gi·∫£i m√£), ho·∫∑c Trailer ch·ªâ l√† 1 ƒëo·∫°n ng·∫Øn c·∫Øt ri√™ng.

**Nguy√™n l√Ω:**
L√∫c Transcode, b√°c t·∫°o ra 2 phi√™n b·∫£n:

1. **Full Movie:** C√≥ Encrypt (AES-128).
2. **Trailer/Preview:** Kh√¥ng Encrypt (Clear HLS).

Khi ƒë√≥, file `.m3u8` c·ªßa b·∫£n Trailer s·∫Ω kh√¥ng c√≥ d√≤ng `#EXT-X-KEY`. Tr√¨nh duy·ªát t·∫£i v·ªÅ l√† ch·∫°y lu√¥n, kh√¥ng th√®m g·ªçi API `/keys` n·ªØa.

* **∆Øu ƒëi·ªÉm:** Nh·∫π server, kh√°ch xem v√®o v√®o.
* **Nh∆∞·ª£c ƒëi·ªÉm:** T·ªën dung l∆∞·ª£ng l∆∞u tr·ªØ (l∆∞u 2 b·∫£n), code Transcode ph·ª©c t·∫°p h∆°n t√≠ (th√™m option `disableEncryption`).

---

### Chi·∫øn thu·∫≠t 3: "Guest ·∫©n danh" (Anonymous Token) üïµÔ∏è‚Äç‚ôÇÔ∏è

*D√πng khi:* B√°c mu·ªën gi·ªõi h·∫°n (VD: Kh√°ch ch·ªâ ƒë∆∞·ª£c xem 3 phim Free m·ªói ng√†y, ho·∫∑c xem 5 ph√∫t ƒë·∫ßu).

1. Khi user v√†o web (ch∆∞a login), Frontend t·ª± g·ªçi API `/auth/guest-login`.
2. Backend c·∫•p 1 c√°i **JWT t·∫°m** (c√≥ role `GUEST`, expire sau 1 ti·∫øng).
3. M·ªçi flow ho·∫°t ƒë·ªông y h·ªát user th∆∞·ªùng.
4. Trong Controller `getKey`, check `role == GUEST` th√¨ √°p d·ª•ng logic gi·ªõi h·∫°n.

---

### üí° L·ªùi khuy√™n cho b√°c

V·ªõi h·ªá th·ªëng hi·ªán t·∫°i (ƒëang encrypt h·∫øt), **Chi·∫øn thu·∫≠t 1** l√† nhanh - g·ªçn - l·∫π nh·∫•t.

* Ch·ªâ c·∫ßn s·ª≠a code Java 1 ch√∫t l√† xong.
* Kh√¥ng ph·∫£i transcode l·∫°i phim.
* V·∫´n t·∫≠n d·ª•ng ƒë∆∞·ª£c c∆° ch·∫ø b·∫£o m·∫≠t (Phim VIP th√¨ Guest g·ªçi API Key v·∫´n b·ªã ch·∫∑n 401).

B√°c th·ª≠ s·ª≠a c√°i Controller theo h∆∞·ªõng **B∆∞·ªõc 2** xem sao nh√©!