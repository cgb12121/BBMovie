Há»‡ thá»‘ng ngon rá»“i thÃ¬ giá» Ä‘áº¿n Ä‘oáº¡n quan trá»ng nháº¥t: **"BÃ o tiá»n" (Monetization)** ğŸ¤‘.

Vá»›i kiáº¿n trÃºc HLS hiá»‡n táº¡i (Master Playlist + Resolution Playlists + AES Encryption), bÃ¡c cÃ³ thá»ƒ chia tier cá»±c ká»³ linh hoáº¡t ngay táº¡i táº§ng **Java Backend**.

DÆ°á»›i Ä‘Ã¢y lÃ  chiáº¿n lÆ°á»£c chia Tier tá»« "BÃ¬nh dÃ¢n" Ä‘áº¿n "Sang cháº£nh" vÃ  cÃ¡ch code cho tá»«ng loáº¡i:

---

### 1. Chiáº¿n lÆ°á»£c chia Tier ğŸ“Š

BÃ¡c cÃ³ thá»ƒ thiáº¿t káº¿ 3 gÃ³i cÆ¡ báº£n nhÆ° Netflix:

| TÃ­nh nÄƒng | **FREE (Tier 0)** | **STANDARD (Tier 1)** | **PREMIUM (Tier 2)** |
| --- | --- | --- | --- |
| **Äá»™ phÃ¢n giáº£i** | Max **480p** | Max **1080p** | **Original / 4K** |
| **Kho phim** | Phim cÅ©/láº» | Full kho | Full kho + Phim sá»›m |
| **Thiáº¿t bá»‹** | 1 mÃ¡y | 2 mÃ¡y | 4 mÃ¡y |
| **Quáº£ng cÃ¡o** | CÃ³ (ChÃ¨n Ä‘oáº¡n .ts quáº£ng cÃ¡o) | KhÃ´ng | KhÃ´ng |

---

### 2. Triá»ƒn khai ká»¹ thuáº­t (How-to Code) ğŸ› ï¸

BÃ¡c sáº½ can thiá»‡p vÃ o 2 chá»—:

1. **API Master Playlist:** Äá»ƒ **áº¨N** cÃ¡c lá»±a chá»n Ä‘á»™ phÃ¢n giáº£i cao vá»›i user Ã­t tiá»n.
2. **API Key:** Äá»ƒ **CHáº¶N** náº¿u user cá»‘ tÃ¬nh Ä‘oÃ¡n URL cá»§a Ä‘á»™ phÃ¢n giáº£i cao.

#### BÆ°á»›c 1: ThÃªm `tier` vÃ o JWT hoáº·c Database

Khi user login, bÃ¡c nhÃ©t luÃ´n cÃ¡i `tier` vÃ o JWT Ä‘á»ƒ Ä‘á»¡ pháº£i query DB nhiá»u láº§n.

```json
// JWT Payload
{
  "sub": "user_123",
  "tier": "FREE", // hoáº·c STANDARD, PREMIUM
  "exp": ...
}

```

#### BÆ°á»›c 2: "Pháº«u thuáº­t" Master Playlist (Quan trá»ng nháº¥t) âœ‚ï¸

Khi Client gá»i láº¥y file `master.m3u8`, bÃ¡c khÃ´ng tráº£ vá» file gá»‘c ngay. BÃ¡c Ä‘á»c file Ä‘Ã³ lÃªn, lá»c bá» nhá»¯ng dÃ²ng khÃ´ng phÃ¹ há»£p vá»›i Tier cá»§a user.

**Logic:**

* User **FREE**: Chá»‰ giá»¯ láº¡i dÃ²ng `#EXT-X-STREAM-INF` nÃ o cÃ³ `RESOLUTION` tháº¥p (<= 854x480).
* User **PREMIUM**: Tráº£ vá» nguyÃªn gá»‘c.

**Code máº«u `StreamController.java`:**

```java
@GetMapping("/{movieId}/master.m3u8")
public ResponseEntity<String> getMasterPlaylist(
        @PathVariable String movieId,
        @AuthenticationPrincipal Jwt jwt) { // Láº¥y thÃ´ng tin User tá»« Token

    String userTier = jwt.getClaimAsString("tier"); // "FREE", "VIP"...

    // 1. Láº¥y ná»™i dung gá»‘c tá»« MinIO/Cache
    String originalContent = streamingService.getMasterM3u8(movieId);

    // 2. Lá»c ná»™i dung dá»±a trÃªn Tier
    String filteredContent = filterPlaylistByTier(originalContent, userTier);

    return ResponseEntity.ok()
            .contentType(MediaType.parseMediaType("application/vnd.apple.mpegurl"))
            .body(filteredContent);
}

// HÃ m lá»c tháº§n thÃ¡nh
private String filterPlaylistByTier(String content, String tier) {
    if ("PREMIUM".equals(tier)) return content; // Äáº¡i gia thÃ¬ cho xem háº¿t

    StringBuilder result = new StringBuilder();
    String[] lines = content.split("\n");

    // Logic Ä‘Æ¡n giáº£n: Äá»c tá»«ng dÃ²ng, náº¿u gáº·p dÃ²ng Ä‘á»‹nh nghÄ©a stream
    // thÃ¬ check Ä‘á»™ phÃ¢n giáº£i xem cÃ³ Ä‘Æ°á»£c phÃ©p khÃ´ng
    boolean skipNextUrl = false;

    for (String line : lines) {
        if (line.startsWith("#EXT-X-STREAM-INF")) {
            // VÃ­ dá»¥ dÃ²ng: #EXT-X-STREAM-INF:BANDWIDTH=...,RESOLUTION=1920x1080
            if ("FREE".equals(tier) && (line.contains("1080") || line.contains("720"))) {
                skipNextUrl = true; // ÄÃ¡nh dáº¥u Ä‘á»ƒ bá» qua dÃ²ng URL tiáº¿p theo
                continue; // Bá» qua dÃ²ng INF nÃ y
            }
            skipNextUrl = false; // Reset náº¿u dÃ²ng nÃ y ok
        } else if (!line.startsWith("#") && skipNextUrl) {
            // ÄÃ¢y lÃ  dÃ²ng URL (playlist.m3u8) cá»§a cÃ¡i resolution bá»‹ cáº¥m
            continue; // Bá» qua luÃ´n
        }

        result.append(line).append("\n");
    }
    return result.toString();
}

```

ğŸ‘‰ **Káº¿t quáº£:** User Free má»Ÿ lÃªn chá»‰ tháº¥y nÃºt chá»n "480p", "360p". KhÃ´ng há» biáº¿t sá»± tá»“n táº¡i cá»§a 1080p.

#### BÆ°á»›c 3: Cháº·n á»Ÿ API Key (Lá»›p báº£o vá»‡ cuá»‘i cÃ¹ng) ğŸ›¡ï¸

Lá»¡ user Free copy Ä‘Æ°á»£c link m3u8 cá»§a báº£n 1080p (do báº¡n bÃ¨ share) vÃ  cá»‘ tÃ¬nh paste vÃ o player?
LÃºc nÃ y Player sáº½ gá»i lÃªn API láº¥y Key. BÃ¡c cháº·n á»Ÿ Ä‘Ã¢y tiáº¿p.

```java
@GetMapping("/keys/{movieId}/{resolution}/{keyFile}")
public ResponseEntity<Resource> getKey(
        @PathVariable String movieId,
        @PathVariable String resolution, // 1080p, 720p...
        @AuthenticationPrincipal Jwt jwt) {

    String userTier = jwt.getClaimAsString("tier");

    // Check quyá»n
    if ("FREE".equals(userTier) && (resolution.equals("1080p") || resolution.equals("720p"))) {
        return ResponseEntity.status(HttpStatus.FORBIDDEN).build(); // 403: MÆ¡ Ä‘i cÆ°ng!
    }

    // Náº¿u ok thÃ¬ tráº£ vá» key
    return serveFile(...);
}

```

---

### 3. TÃ­nh nÄƒng nÃ¢ng cao: Kiá»ƒm soÃ¡t sá»‘ lÆ°á»£ng thiáº¿t bá»‹ (Concurrent Streams) ğŸ“±ğŸ’»

CÃ¡i nÃ y Ä‘á»ƒ trÃ¡nh 1 Ã´ng mua gÃ³i Premium rá»“i share cho cáº£ lÃ ng xem.

**Logic:**

1. Má»—i khi User gá»i API láº¥y Key (hoáº·c Master Playlist), bÃ¡c lÆ°u vÃ o **Redis**: `key: viewing_session:{userId}:{movieId}`.
2. Set thá»i gian háº¿t háº¡n (TTL) cho key Ä‘Ã³ khoáº£ng 5 phÃºt (Key rotation interval).
3. Äáº¿m sá»‘ lÆ°á»£ng key active cá»§a User Ä‘Ã³.
4. Náº¿u > giá»›i háº¡n gÃ³i -> Tráº£ vá» lá»—i 429 (Too Many Requests).

### 4. TÃ­nh nÄƒng "HÃºt mÃ¡u": ChÃ¨n quáº£ng cÃ¡o (SSAI - Server Side Ad Insertion) ğŸ“º

CÃ¡ch Ä‘Æ¡n giáº£n nháº¥t cho ngÆ°á»i má»›i:

* Táº¡o má»™t video quáº£ng cÃ¡o ngáº¯n (vÃ­ dá»¥ 5s), transcode ra HLS y há»‡t phim.
* Trong hÃ m `filterPlaylistByTier` (BÆ°á»›c 2), náº¿u lÃ  User FREE:
* BÃ¡c chÃ¨n thÃªm dÃ²ng `#EXT-X-DISCONTINUITY` vÃ  link segment quáº£ng cÃ¡o vÃ o **Ä‘áº§u file** playlist con (Resolution Playlist).
* CÃ¡i nÃ y hÆ¡i nÃ¢ng cao vÃ¬ pháº£i sá»­a file m3u8 con, nhÆ°ng hiá»‡u quáº£ thÃ¬ tuyá»‡t vá»i vÃ¬ quáº£ng cÃ¡o nÃ³ liá»n máº¡ch vá»›i phim, khÃ´ng cháº·n Ä‘Æ°á»£c (AdBlock khÃ³c thÃ©t).



### ğŸ¯ TÃ³m láº¡i lá»™ trÃ¬nh "LÃ m giÃ u"

1. **HÃ´m nay:** Sá»­a láº¡i DB user, thÃªm trÆ°á»ng `tier`.
2. **NgÃ y mai:** Code cÃ¡i hÃ m `filterPlaylistByTier` Ä‘á»ƒ áº©n 1080p vá»›i dÃ¢n Free.
3. **NgÃ y kia:** Code cháº·n Key á»Ÿ Controller.
4. **Cuá»‘i tuáº§n:** Deploy lÃªn VPS, má»i anh em vÃ o test, thu phÃ­ trÃ  Ä‘Ã¡/cafe! â˜•ï¸ğŸ’°